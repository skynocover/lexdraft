# LexDraft â€” Scrum é–‹ç™¼è¨ˆç•«

## Backlog â€” åŠŸèƒ½è¦åŠƒ

> ä¾å„ªå…ˆç´šæ’åºã€‚æ¯å€‹ç¾¤çµ„å…§çš„é …ç›®å¯ç¨ç«‹é–‹ç™¼ã€‚

### A. ç·¨è¼¯å™¨ & AI æ›¸å¯«é«”é©—

- [x] æ®µè½ç´š AI æ“ä½œï¼šé¸å–æ®µè½å¾Œé¡¯ç¤º inline è¼¸å…¥æ¡†ï¼Œå¯è«‹ AI é‡å¯«/åŠ å¼·/ç²¾ç°¡ï¼ˆé¡ä¼¼ v0 çš„äº’å‹•æ–¹å¼ï¼‰
- [x] å‹•æ…‹å¿«æ·æŒ‰éˆ•ï¼šAI æ ¹æ“šæ›¸ç‹€ç•¶å‰ç‹€æ…‹å‹•æ…‹ç”Ÿæˆå»ºè­°æ“ä½œæŒ‰éˆ•
- [x] å°è©± Rewindï¼šAI ä¿®æ”¹æ›¸ç‹€å¾Œå¯åœ¨å°è©±ä¸­ä¸€éµé€€å›è©²æ¬¡ä¿®æ”¹ï¼ˆé€€å›å–®æ¬¡å°è©±æ‰€åšçš„æ‰€æœ‰è®Šæ›´ï¼Œä¸åŒæ–¼ç‰ˆæœ¬ç´€éŒ„ï¼‰
- [x] æ®µè½ä¿®æ”¹æ”¯æ´ï¼šwrite_brief_section æ”¯æ´ä¿®æ”¹æ—¢æœ‰æ®µè½ï¼ˆè‡ªå‹•åŒ¹é… section/subsection æˆ–ç”¨ paragraph_idï¼‰

### B. è³‡æ–™é€£å‹• & åˆ†æ

- [ ] é‡‘é¡èˆ‡æ›¸ç‹€é›™å‘åŒæ­¥ï¼šäº’å‹•å¼é‡‘é¡è¡¨æ ¼ï¼Œä¿®æ”¹é‡‘é¡è‡ªå‹•é€£å‹•è¨´ä¹‹è²æ˜æ®µè½
- [ ] çˆ­é»å¯é»æ“Šè·³è½‰åˆ°å°æ‡‰æ›¸ç‹€æ®µè½ï¼ˆæ‰‹å‹•æˆ–è‡ªå‹•æ¨™è¨˜ï¼‰
- [x] åˆ—å‡ºçˆ­åŸ·èˆ‡éçˆ­åŸ·äº‹é …
- [ ] æ™‚é–“è»¸ç¨ç«‹æ”¾ç½®ï¼ˆå¾…ç¢ºå®šå½¢å¼ï¼šç¨ç«‹ tab æˆ–å…¶ä»–ï¼‰
- [ ] ç‰ˆæœ¬æ¯”å°æ¨¡å¼ï¼šå·¦å³é›™æ¬„ diff viewï¼Œèªæ„å±¤ç´šæ®µè½æ¯”å°

### C. Agent æ¶æ§‹ & è‡ªå‹•åŒ–

- [ ] æ¡ˆä»¶ Onboarding + AI ä¸€éµåˆå§‹åŒ–ï¼šå¼•å°æµç¨‹ï¼ˆå¡«å¯«è³‡æ–™ â†’ ä¸Šå‚³æª”æ¡ˆ â†’ AI åˆ†æç”¢ç”Ÿçˆ­é»/æ™‚é–“è»¸/ç•¶äº‹äººï¼‰
- [x] Sub Agent æ¶æ§‹ï¼šwrite_full_brief pipelineï¼ˆPlanner + Writer sub-agentsï¼‰ï¼Œä¸€æ¬¡å·¥å…·å‘¼å«å®Œæˆæ•´ä»½æ›¸ç‹€
- [x] Pipeline v3 Phase 1aï¼šè«–è­‰ç­–ç•¥ Step + Writer Context æ”¹å–„ï¼ˆContextStoreã€Claim Graphã€3å±¤ Writer Contextã€ç­–ç•¥é©—è­‰ + Retryï¼‰
- [x] Pipeline v3 Phase 1bï¼šå‰ç«¯é€²åº¦ UI èª¿æ•´ï¼ˆReviewContentã€æ”»/é˜²/åƒ badgesã€step childrenã€ç­–ç•¥ rendererï¼‰
- [x] Pipeline v3 Phase 2ï¼šæ³•å¾‹ç ”ç©¶ Agentï¼ˆæ‰¹æ¬¡å±•é–‹ + MongoDB æœå°‹è¿´åœˆï¼‰
- [x] Pipeline v3 Phase 3aï¼šOrchestrator Agent å–ä»£ Step 1ï¼ˆæ¡ˆä»¶åˆ†æã€ç•¶äº‹äººã€çˆ­é»ã€è³‡è¨Šç¼ºå£ï¼‰
- [x] Pipeline v3 Phase 3bï¼šäº‹å¯¦çˆ­è­°ç®¡ç† + å®Œæ•´ Claim Graph
- [x] Pipeline v3 Phase 4ï¼šå“è³ªå¯©æŸ¥ï¼ˆçµæ§‹åŒ–å‰æª¢ + LLM å¯©æŸ¥ï¼‰
- [x] Pipeline é€²åº¦å„ªåŒ–ï¼šéš±è—èˆŠé€²åº¦æ¢ã€æ³•æ¢æœå°‹é¡¯ç¤ºé€ç­†æŸ¥è©¢é€²åº¦ï¼ˆå¯å±•é–‹çœ‹çµæœï¼‰ã€è‡ªå‹•å»é™¤é‡è¤‡æ¨™é¡Œ
- [x] æ³•æ¢å¼•ç”¨åˆ‡æ›æ›¸ç‹€æ™‚æ­£ç¢ºæ›´æ–°ï¼šæ”¹ç‚ºåƒ…ä¾æ“šç•¶å‰æ›¸ç‹€æ®µè½å¼•ç”¨åˆ¤æ–·å·²å¼•ç”¨/å‚™ç”¨
- [x] æ³•æ¢æœå°‹å„ªåŒ–ï¼šPCode ç›´æ¥æŸ¥è¡¨ã€åˆ¥åè§£æï¼ˆæ¶ˆä¿æ³•â†’æ¶ˆè²»è€…ä¿è­·æ³•ï¼‰ã€æ¢è™Ÿæ ¼å¼æ¨™æº–åŒ–ã€searchLawBatch æ¸›å°‘é€£ç·šæ•¸
- [ ] ç”¨æˆ¶è‡ªå®šç¾©æŒ‡ä»¤ï¼šå¾‹å¸«å¯å»ºç«‹å¸¸ç”¨ prompt æŒ‡ä»¤é›†
- [ ] æ³•æ¢æŸ¥è©¢çš„æ–¹å¼ æ˜¯å¦æ‡‰è©²å¦‚æœæ²’æŸ¥åˆ° å°±æŸ¥åˆ¥çš„è³‡æ–™ è€Œä¸æ˜¯ç”±ä¸»è¦çš„agent ä¾†æ±ºå®š è€Œæ˜¯å¯«æ›¸ç‹€çš„äººæ±ºå®š é€™æ¨£ç”±haikuæŸ¥è©¢æ˜¯å¥½äº‹å—?

### D. æ–‡ä»¶ç®¡ç† & æ¨¡æ¿

- [ ] ç•«é¢é‡æ–°è¦åŠƒï¼šä»¥æ›¸ç‹€ + å·å®—ç‚ºæ ¸å¿ƒé‡æ–°è¨­è¨ˆä½ˆå±€
- [ ] æ¨¡æ¿ç³»çµ±ï¼šé è¨­æ›¸ç‹€æ¨¡æ¿ï¼ˆæ°‘äº‹èµ·è¨´ç‹€ã€æº–å‚™æ›¸ç‹€ã€ä¸Šè¨´ç‹€ç­‰ï¼‰
- [x] æ³•æ¢å¼•ç”¨å€é‡æ–°è¨­è¨ˆï¼ˆis_manual å€åˆ†æ‰‹å‹•/AIã€å¼•ç”¨å€=è¢«å¼•ç”¨ã€å‚™ç”¨å€=æ‰‹å‹•æœªå¼•ç”¨ã€AIæœªå¼•ç”¨è‡ªå‹•æ¸…ç†ï¼‰
- [ ] å…¨æ–‡æœå°‹ï¼šæœå°‹ PDFã€æ›¸ç‹€è‰ç¨¿ã€æ³•æ¢ç­‰æ‰€æœ‰å…§å®¹

### E. åŒ¯å‡º

- [ ] Word åŒ¯å‡ºï¼ˆ`POST /api/briefs/:id/export/docx`ï¼‰
  - [ ] å®‰è£ docxï¼ˆdocx-jsï¼‰
  - [ ] Word æ ¼å¼ï¼šA4ã€é‚Šè· 2.54/3.17cmã€æ¨™æ¥·é«”/æ–°ç´°æ˜é«”ã€12pt å…§æ–‡ã€1.8 å€è¡Œè·
  - [ ] å¼•ç”¨è½‰æ›ï¼šinline badge â†’ æ‹¬è™Ÿå¼•ç”¨æ–‡å­—ï¼ˆå¦‚ã€Œï¼ˆåŸè­‰ä¸€ï¼Œäº‹æ•…åˆ†æç ”åˆ¤è¡¨ï¼‰ã€ï¼‰
  - [ ] content_structured â†’ docx æ®µè½æ˜ å°„ï¼ˆsection/subsection å°æ‡‰ heading å±¤ç´šï¼‰
  - [ ] å‰ç«¯ï¼šHeaderã€Œä¸‹è¼‰ Wordã€æŒ‰éˆ•
- [ ] PDF åŒ¯å‡ºï¼ˆ`POST /api/briefs/:id/export/pdf`ï¼ŒåµŒå…¥ Noto Serif TC å­—é«”ï¼‰

### F. ç³»çµ± & æ¬Šé™

- [ ] å®Œæ•´èªè­‰ç³»çµ±ï¼ˆemail/password + PBKDF2 via Web Crypto APIï¼Œregister/login/logoutï¼‰
- [ ] å¤šç”¨æˆ¶ / åœ˜éšŠå”ä½œï¼ˆRBACã€æ¡ˆä»¶æ¬Šé™æ§ç®¡ï¼‰
- [ ] æœˆåº¦ token budget ä¸Šé™ + å‘Šè­¦

### G. å¾…è¨è«–

- [ ] Smart Chipsï¼ˆæ™ºæ…§æ¨™ç±¤ï¼‰ï¼šè‡ªå‹•è­˜åˆ¥äººåã€æ™‚é–“ã€é‡‘é¡ï¼Œé»æ“Šå¯è·³è½‰æ™‚é–“è»¸äº‹ä»¶æˆ–ç¢ºèªçŸ›ç›¾
- [ ] æ›¸ç‹€æ ¼å¼å¼·åŒ–ï¼šè¡Œè·/æ®µè·èª¿æ•´ã€æ®µè½ç·¨è™Ÿçš„å¯è¦–åŒ–ï¼ˆæ›´æ¥è¿‘æ³•é™¢æ›¸ç‹€æ ¼å¼ï¼‰

---

## Phase 3 â€” å¥å£¯æ€§æå‡ï¼ˆRobustnessï¼‰

> ç›®æ¨™ï¼šæå‡ç³»çµ±ç©©å®šåº¦èˆ‡å¯ç¶­è­·æ€§ï¼Œçµ±ä¸€éŒ¯èª¤è™•ç†ã€åŠ å…¥é©—è­‰å±¤ã€æ”¹å–„ä½¿ç”¨è€…å›é¥‹ã€‚

### 3.1 Zod é©—è­‰å±¤

- [ ] å®‰è£ zod + @hono/zod-validator
- [ ] ç‚ºæ‰€æœ‰ API route çš„ request body åŠ å…¥ Zod schema é©—è­‰
  - [ ] `POST /api/cases` â€” title required, case_number optional string
  - [ ] `PUT /api/cases/:id` â€” partial case fields
  - [ ] `PUT /api/files/:id` â€” category enum, doc_type enum, doc_date optional
  - [ ] `PUT /api/briefs/:id` â€” title string, content_structured object
  - [ ] `POST /api/law/search` â€” query required string, limit optional number
- [ ] Agent tool arguments åŠ å…¥ runtime Zod é©—è­‰ï¼ˆæ›¿ä»£ç›®å‰çš„ `as string` å¼·åˆ¶å‹åˆ¥è½‰æ›ï¼‰
- [ ] çµ±ä¸€éŒ¯èª¤å›å‚³æ ¼å¼ï¼š`{ error: string, details?: ZodError['issues'] }`

### 3.2 éŒ¯èª¤è™•ç†çµ±ä¸€

- [ ] å»ºç«‹ `src/server/lib/errors.ts`ï¼šAppError classï¼ˆstatusCode + message + codeï¼‰
- [ ] Hono global error handlerï¼šæ•ç² AppError â†’ å›å‚³çµæ§‹åŒ–éŒ¯èª¤ JSON
- [ ] Agent tool åŸ·è¡ŒéŒ¯èª¤ï¼šçµ±ä¸€ç”¨ toolError helperï¼ŒåŠ å…¥ error code åˆ†é¡
- [ ] AI API å‘¼å«ï¼šåŠ å…¥ retry with exponential backoffï¼ˆæœ€å¤š 3 æ¬¡ï¼‰
- [ ] Queue Consumerï¼šå¤±æ•—æ™‚å¯«å› D1ï¼ˆstatus: error + error_messageï¼‰ï¼Œæ”¯æ´æ‰‹å‹•é‡è©¦

### 3.3 å‰ç«¯éŒ¯èª¤è™•ç† & é€šçŸ¥

- [ ] å»ºç«‹å…¨åŸŸ Toast ç³»çµ±ï¼ˆuseToastStore æˆ–è¼•é‡ contextï¼‰
- [ ] API éŒ¯èª¤è‡ªå‹• toastï¼ˆæª”æ¡ˆä¸Šå‚³å¤±æ•—ã€æ›¸ç‹€å„²å­˜å¤±æ•—ã€æ³•æ¢æœå°‹å¤±æ•—ç­‰ï¼‰
- [ ] æˆåŠŸæ“ä½œ toastï¼ˆæ›¸ç‹€å·²å„²å­˜ã€æª”æ¡ˆå·²åˆªé™¤ç­‰ï¼‰
- [ ] SSE é€£ç·šä¸­æ–· toast + è‡ªå‹•é‡é€£æç¤º
- [ ] Agent loop ç•°å¸¸ä¸­æ–·ï¼šå‰ç«¯é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ã€å…è¨±é‡æ–°ç™¼é€æŒ‡ä»¤
- [ ] PDF æ–‡å­—æå–å¤±æ•—ï¼šå‰ç«¯é¡¯ç¤ºã€Œç„¡æ³•æå–æ–‡å­—ï¼Œè«‹ç¢ºèª PDF éç´”åœ–ç‰‡æƒææª”ã€
- [ ] æª”æ¡ˆä¸Šå‚³å¤±æ•—ï¼šR2 å¯«å…¥å¤±æ•—å›æ»¾ D1 è¨˜éŒ„ã€å‰ç«¯é¡¯ç¤ºå…·é«”éŒ¯èª¤åŸå› 
- [ ] Token / æˆæœ¬è¶…é™ï¼šæ¥è¿‘ä¸Šé™æ™‚ Status Bar è­¦å‘Šã€è¶…é™æ™‚é˜»æ­¢æ–°çš„ Agent è«‹æ±‚

### 3.4 é…ç½®æ¸…ç†

- [ ] å°‡ AI model nameã€max roundsã€file size limits ç­‰ç¡¬ç·¨ç¢¼å€¼æŠ½åˆ°å…±ç”¨ config
- [ ] çµ±ä¸€ AI prompt templates åˆ° `src/server/agent/prompts.ts`
- [ ] ç§»é™¤é–‹ç™¼ç”¨ console.errorï¼Œæ”¹ç‚ºçµæ§‹åŒ– logging

---

## UI é‡æ§‹ â€” Chat å·¦å´ + Editor ä¸­å¤® + 2 Tab Sidebar å³å´

> ç›®æ¨™ï¼šç§»é™¤åº•éƒ¨åˆ†æé¢æ¿ï¼Œæœ€å¤§åŒ–ç·¨è¼¯å™¨å‚ç›´ç©ºé–“ï¼›Chat ä¿ç•™åœ¨å·¦å´æ–¹ä¾¿åŒæ™‚æŸ¥çœ‹ AI å›è¦†èˆ‡ç·¨è¼¯æ›¸ç‹€ã€‚
> è¨­è¨ˆåŸå‰‡ï¼šå¾‹å¸« 80% æ™‚é–“åœ¨å¯«æ›¸ç‹€ï¼Œç·¨è¼¯å™¨æ˜¯ç¬¬ä¸€å„ªå…ˆï¼›AI å°è©±éœ€è¦èˆ‡ç·¨è¼¯å™¨åŒæ™‚å¯è¦‹ï¼›æ¡ˆä»¶è³‡æ–™å’Œåˆ†æéš¨æ‰‹å¯æŸ¥ã€‚

### ä½ˆå±€å°ç…§

```
ã€ç¾åœ¨ã€‘ä¸‰æ¬„ + åº•éƒ¨é¢æ¿                    ã€é‡æ§‹å¾Œã€‘Chatå·¦ + Editorä¸­(å…¨é«˜) + 2 Tab Sidebarå³
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Chat   â”‚  Editor      â”‚ Right  â”‚     â”‚ Chat   â”‚                  â”‚ğŸ“‹â”‚ æ¡ˆä»¶è³‡æ–™â”‚
â”‚ Panel  â”‚              â”‚Sidebar â”‚     â”‚ Panel  â”‚  Editor           â”‚ğŸ“Šâ”‚        â”‚
â”‚ (w-80) â”‚              â”‚ (w-80) â”‚     â”‚ (w-80) â”‚  (å…¨é«˜ï¼Œç„¡åº•éƒ¨é¢æ¿) â”‚  â”‚ [å…§å®¹] â”‚
â”‚        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚     â”‚        â”‚  ~700px           â”‚  â”‚ ~380px â”‚
â”‚        â”‚BottomPanel   â”‚        â”‚     â”‚        â”‚                  â”‚  â”‚        â”‚
â”‚        â”‚(çˆ­é»/é‡‘é¡/â€¦) â”‚        â”‚     â”‚        â”‚                  â”‚  â”‚        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
ç·¨è¼¯å™¨ï¼šå¯¬~480pxï¼Œé«˜åº¦è¢«åº•éƒ¨é¢æ¿å£“ç¸®      ç·¨è¼¯å™¨ï¼šå¯¬~700pxï¼Œå…¨é«˜å¯ç”¨
```

### æ ¸å¿ƒæ”¹å‹•

1. **ç§»é™¤åº•éƒ¨é¢æ¿**ï¼šåˆ†æåŠŸèƒ½ï¼ˆçˆ­é»/é‡‘é¡/æ™‚é–“è»¸ç­‰ï¼‰å¾åº•éƒ¨é¢æ¿æ¬åˆ°å³å´ Sidebar
2. **Chat ç•™åœ¨å·¦å´**ï¼šå¾‹å¸«å¯ä»¥åŒæ™‚çœ‹ AI å°è©±å’Œç·¨è¼¯å™¨ï¼Œä¸éœ€è¦åœ¨ tab ä¹‹é–“åˆ‡æ›
3. **å³å´ Sidebar å‡ç´šç‚º 2 Tab**ï¼šæ¡ˆä»¶è³‡æ–™ + åˆ†æï¼Œå–ä»£åŸæœ¬åªæœ‰æ¡ˆä»¶è³‡æ–™çš„å–®ä¸€é¢æ¿

### ç·¨è¼¯å™¨ç©ºé–“æå‡

- **å¯¬åº¦**ï¼šç§»é™¤åº•éƒ¨é¢æ¿çš„ tab bar å¾Œï¼Œå³å´ Sidebar å¾å›ºå®š `w-80`ï¼ˆ320pxï¼‰æ”¹ç‚ºå¯èª¿æ•´ï¼ˆé è¨­ ~400pxï¼‰ï¼ŒEditor åœ¨ 1440px è¢å¹•ä¸Šç´„ 700pxï¼ˆåŸ ~480pxï¼Œæå‡ 46%ï¼‰
- **é«˜åº¦**ï¼šåº•éƒ¨é¢æ¿ä½” 200~500pxï¼Œç§»é™¤å¾Œ Editor å–å¾—å…¨éƒ¨å‚ç›´ç©ºé–“ï¼ˆæœ€å¤§æ”¹å–„ï¼‰

### å³å´ Sidebar â€” 2 Tab è¦åŠƒ

| Tab é †åº | åç¨±     | Icon (lucide) | å…§å®¹ä¾†æº                                               | èªªæ˜                                         |
| -------- | -------- | ------------- | ------------------------------------------------------ | -------------------------------------------- |
| 1        | æ¡ˆä»¶è³‡æ–™ | `FolderOpen`  | åŸ `BriefsSection` + `FilesSection` + `LawRefsSection` | æ›¸ç‹€ + å·å®— + æ³•æ¢åˆä½µï¼ŒCollapsible sections |
| 2        | åˆ†æ     | `BarChart3`   | åŸ `AnalysisPanel`ï¼ˆåº•éƒ¨é¢æ¿ï¼‰                         | 6 å€‹ sub-sectionï¼ˆAccordion å±•é–‹/æ”¶åˆï¼‰      |

### æ¡ˆä»¶è³‡æ–™ Tab å…§éƒ¨çµæ§‹ï¼ˆCollapsible Sectionsï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ æ¡ˆä»¶è³‡æ–™               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¼ æ›¸ç‹€è‰ç¨¿ (2)           â”‚  â† é è¨­å±•é–‹ï¼Œé …ç›®å°‘
â”‚   â”Œ æ°‘äº‹èµ·è¨´ç‹€ â”€â”€â”€â”€â”     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚   â”Œ æº–å‚™æ›¸ç‹€ â”€â”€â”€â”€â”€â”     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                         â”‚
â”‚ â–¼ æ¡ˆä»¶å·å®— (8)    [+ä¸Šå‚³] â”‚  â† é è¨­å±•é–‹
â”‚   â–¶ æˆ‘æ–¹æ›¸ç‹€ (2)         â”‚     FileGroup äºŒç´šæ”¶åˆ
â”‚   â–¶ å°æ–¹æ›¸ç‹€ (3)         â”‚
â”‚   â–¶ è­‰æ“šè³‡æ–™ (3)         â”‚
â”‚                         â”‚
â”‚ â–¶ æ³•æ¢å¼•ç”¨ (12)    [ğŸ”]  â”‚  â† é è¨­æ”¶åˆï¼Œéœ€è¦æ™‚å±•é–‹
â”‚                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ›¸ç‹€/å·å®—/æ³•æ¢ä¸‰å€‹å€å¡Šå„è‡ªå¯æ”¶åˆï¼Œæ­é… FileGroup çš„äºŒç´šæ”¶åˆï¼Œå³ä½¿æª”æ¡ˆå¤šä¹Ÿä¸æœƒéé•·ã€‚

### åˆ†æ Tab å…§éƒ¨çµæ§‹ï¼ˆAccordionï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“Š åˆ†æ                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â–¼ çˆ­é»åˆ†æ (3)          â”‚  â† é¡¯ç¤ºæ•¸é‡ badge
â”‚   â”Œ DisputeCard â”       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚   â”Œ DisputeCard â”       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                         â”‚
â”‚ â–¶ ä¸»å¼µåœ–è­œ (12)         â”‚  â† æ”¶åˆç‹€æ…‹
â”‚ â–¶ é‡‘é¡è¨ˆç®— NT$1,234,567 â”‚  â† é‡‘é¡ badge
â”‚ â–¶ æ™‚é–“è»¸ (8)            â”‚
â”‚ â–¶ ä¸»å¼µèˆ‡èˆ‰è­‰             â”‚
â”‚ â–¶ ç•¶äº‹äºº                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æ¯å€‹ Accordion Item ç›´æ¥å¾©ç”¨ç¾æœ‰çš„ Tab å…ƒä»¶ï¼ˆ`DisputesTab`ã€`DamagesTab` ç­‰ï¼‰ï¼Œåªéœ€èª¿æ•´å®¹å™¨å¯¬åº¦é©é…ã€‚

### ChatPanel é…å¥—æªæ–½

Chat ä¿ç•™åœ¨å·¦å´ï¼Œä½†éœ€è¦ä»¥ä¸‹èª¿æ•´é…åˆæ–°ä½ˆå±€ï¼š

- **Chat æ”¶åˆæ¢ä¿ç•™**ï¼šæ”¶åˆæ™‚é¡¯ç¤º `SidebarStrip`ï¼ˆèˆ‡ç¾åœ¨ç›¸åŒï¼‰
- **ä¸²æµæŒ‡ç¤ºå™¨**ï¼šAI å›æ‡‰ä¸­æ™‚ Chat header é¡¯ç¤º pulsing dot å‹•ç•«
- **`Cmd+J` å¿«æ·éµ**ï¼šä¸€éµå±•é–‹ Chat + focus è¼¸å…¥æ¡†
- **SelectionToolbar â†’ Chat**ï¼šé¸å–æ–‡å­— â†’ é»ã€Œé€åˆ° AIã€â†’ è‡ªå‹•å±•é–‹ Chat + å¡«å…¥ promptï¼ˆèˆ‡ç¾æœ‰è¡Œç‚ºç›¸åŒï¼‰
- **`brief_update` SSE ä¸å—å½±éŸ¿**ï¼šäº‹ä»¶ç›´æ¥æ›´æ–° editor + storesï¼Œèˆ‡ Chat é¢æ¿ç‹€æ…‹ç„¡é—œ

---

### Phase 0ï¼šå‰ç½®æº–å‚™

- [x] 0.1 å®‰è£ shadcn/uiï¼ˆ`npx shadcn@latest init`ï¼Œç¢ºèª Tailwind v4 ç›¸å®¹è¨­å®šï¼‰
- [x] 0.2 å®‰è£éœ€è¦çš„ shadcn å…ƒä»¶ï¼š
  - `npx shadcn@latest add accordion` â€” åˆ†æé¢æ¿ Accordion
  - `npx shadcn@latest add collapsible` â€” æ¡ˆä»¶è³‡æ–™é¢æ¿çš„æ”¶åˆå€å¡Š
  - `npx shadcn@latest add tooltip` â€” Icon tab hover æç¤º
- [x] 0.3 ç¢ºèª shadcn çš„ CSS variable èˆ‡ç¾æœ‰ `app.css` çš„ `--color-bg-1`ã€`--color-t1` ç­‰ token ä¸è¡çªï¼Œå»ºç«‹æ˜ å°„

### Phase 1ï¼šé‡æ§‹ useUIStore + CaseWorkspace ä½ˆå±€

> ç§»é™¤åº•éƒ¨é¢æ¿ç‹€æ…‹ï¼Œæ–°å¢å³å´ Sidebar 2 Tab ç‹€æ…‹ï¼ŒåŒæ­¥æ›´æ–°ä¸»ä½ˆå±€ã€‚Chat å·¦å´é¢æ¿ä¿æŒä¸å‹•ã€‚

- [x] 1.1 æ›´æ–° `useUIStore` ç‹€æ…‹çµæ§‹ï¼š

  ```ts
  type SidebarTab = 'case-materials' | 'analysis';

  interface UIState {
    // å·¦å´ Chatï¼ˆä¿ç•™ç¾æœ‰ï¼‰
    leftSidebarOpen: boolean;

    // å³å´ Sidebar
    sidebarOpen: boolean; // sidebar å±•é–‹/æ”¶åˆ
    sidebarTab: SidebarTab; // ç•¶å‰ tabï¼š2 é¸ 1
    analysisAccordion: string[]; // åˆ†æé¢æ¿ä¸­å±•é–‹çš„ accordion é …ç›®

    // æ¡ˆä»¶è³‡æ–™ Tab å…§çš„æ”¶åˆç‹€æ…‹
    caseMaterialSections: {
      briefs: boolean; // æ›¸ç‹€å€å¡Šå±•é–‹ï¼ˆé è¨­ trueï¼‰
      files: boolean; // å·å®—å€å¡Šå±•é–‹ï¼ˆé è¨­ trueï¼‰
      lawRefs: boolean; // æ³•æ¢å€å¡Šå±•é–‹ï¼ˆé è¨­ falseï¼‰
    };

    // ä¿ç•™
    rightFilesOpen: boolean;
    rightLawRefsOpen: boolean;

    // ç§»é™¤ï¼šrightSidebarOpen, bottomPanelOpen, bottomPanelHeight, bottomPanelTab
  }
  ```

- [x] 1.2 æ–°å¢ `SidebarTab` type å’Œå°æ‡‰çš„ toggle/set æ–¹æ³•
- [x] 1.3 ç§»é™¤èˆŠçš„ `bottomPanel*` å’Œ `rightSidebarOpen` ç›¸é—œç‹€æ…‹èˆ‡æ–¹æ³•
- [x] 1.4 ä¿ç•™ `leftSidebarOpen` / `toggleLeftSidebar`ï¼ˆChat é¢æ¿å±•é–‹/æ”¶åˆï¼‰
- [x] 1.5 ä¿ç•™ `rightFilesOpen` / `rightLawRefsOpen`ï¼ˆFileGroup äºŒç´šå±•é–‹ç‹€æ…‹ä»éœ€è¦ï¼‰
- [x] 1.6 æ›´æ–° `CaseWorkspace.tsx`ï¼š
  ```
  æ”¹å‰ï¼š<ChatPanel /> + <main>(<Editor /> + <AnalysisPanel />)</main> + <RightSidebar />
  æ”¹å¾Œï¼š<ChatPanel /> + <main>(<Editor />)</main> + <NewRightSidebar />
  ```
  - Chat å·¦å´é¢æ¿ + SidebarStrip ä¿æŒä¸å‹•
  - ç§»é™¤ `<AnalysisPanel />`ï¼ˆå¾åº•éƒ¨æ¬åˆ°å³å´ Sidebarï¼‰
  - Editor å–å¾—å®Œæ•´å‚ç›´é«˜åº¦ï¼ˆ`flex-1`ï¼Œä¸å†èˆ‡ AnalysisPanel åˆ†å‰²ï¼‰
- [x] 1.7 ä¸»å€åŸŸä½ˆå±€ï¼šChat å·¦å´å›ºå®šå¯¬åº¦ + Editor flex-1 å…¨é«˜ + RightSidebar 2-tab icon bar
  - æ³¨æ„ï¼šChat å’Œ Sidebar ä½¿ç”¨å›ºå®šå¯¬åº¦è€Œé resizable panelsï¼Œä¿æŒèˆ‡åŸè¨­è¨ˆä¸€è‡´
  - Sidebar æ”¶åˆæ™‚åªé¡¯ç¤º icon bar (w-10)ï¼Œå±•é–‹æ™‚é¡¯ç¤º icon bar + å…§å®¹å€
- [x] 1.8 DndContext ä¿æŒä¸è®Šï¼ˆeditor å…§éƒ¨ tab æ‹–æ‹½ï¼‰
- [x] 1.9 ä¿ç•™ StatusBar

### Phase 2ï¼šå³å´ Sidebar é‡æ§‹

> å»ºç«‹ 2 Tab Sidebarï¼Œæ•´åˆæ¡ˆä»¶è³‡æ–™ + åˆ†æé¢æ¿ã€‚

#### 2.1 Sidebar å¤–æ®¼

- [x] 2.1.1 é‡å¯« `RightSidebar.tsx`ï¼š
  - çµæ§‹ï¼šicon tab barï¼ˆå·¦å´å‚ç›´æ’åˆ—ï¼‰+ å…§å®¹å€
  - Icon tab bar å¯¬åº¦å›ºå®š `w-10`ï¼Œæ¯å€‹ icon 40x40 å¯é»æ“Šå€åŸŸ
  - å…§å®¹å€ flex-1ï¼Œå¯¬åº¦ç”± sidebar æ•´é«”å¯¬åº¦æ±ºå®š
  - Sidebar æ•´é«”å¯æ‹–æ‹½èª¿æ•´å¯¬åº¦ï¼ˆå·¦é‚Šç·£æ‹–æ‹½ï¼Œç”± resizable panel è™•ç†ï¼‰
- [x] 2.1.2 æ”¶åˆç‹€æ…‹ï¼šåªé¡¯ç¤º icon tab barï¼ˆw-10ï¼‰ï¼Œé»æ“Šä»»ä¸€ icon å±•é–‹ sidebar ä¸¦åˆ‡æ›åˆ°è©² tab
- [x] 2.1.3 å±•é–‹ç‹€æ…‹ä¸‹é»æ“Šç•¶å‰ active tab icon â†’ æ”¶åˆ sidebar

```
å±•é–‹ç‹€æ…‹ï¼š                     æ”¶åˆç‹€æ…‹ï¼š
â”Œâ”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”
â”‚ğŸ“‹â”‚ æ¡ˆä»¶è³‡æ–™           â”‚       â”‚ğŸ“‹â”‚
â”‚ğŸ“Šâ”‚                   â”‚       â”‚ğŸ“Šâ”‚
â”‚  â”‚ [tab å…§å®¹]        â”‚       â”‚  â”‚
â””â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”˜
```

#### 2.2 æ¡ˆä»¶è³‡æ–™ Tabï¼ˆæ›¸ç‹€ + å·å®— + æ³•æ¢ï¼‰

- [x] 2.2.1 å»ºç«‹ `CaseMaterialsContent` å…ƒä»¶
- [x] 2.2.2 ä½¿ç”¨ shadcn `Collapsible` åŒ…è£ä¸‰å€‹å€å¡Šï¼š
  - æ›¸ç‹€è‰ç¨¿ï¼ˆ`BriefsSection`ï¼‰â€” é è¨­å±•é–‹
  - æ¡ˆä»¶å·å®—ï¼ˆ`FilesSection`ï¼‰â€” é è¨­å±•é–‹
  - æ³•æ¢å¼•ç”¨ï¼ˆ`LawRefsSection`ï¼‰â€” é è¨­æ”¶åˆ
- [x] 2.2.3 æ¯å€‹ Collapsible header é¡¯ç¤ºåç¨± + æ•¸é‡ badge + å±•é–‹/æ”¶åˆ chevron
- [x] 2.2.4 æ”¶åˆç‹€æ…‹å­˜åœ¨ `useUIStore.caseMaterialSections` ä¸­ï¼Œåˆ‡æ› tab å¾Œä¿ç•™
- [x] 2.2.5 ç§»é™¤ `BriefsSection`ã€`FilesSection`ã€`LawRefsSection` çš„å¤–å±¤ `border-b`ï¼Œæ”¹ç”± Collapsible çµ±ä¸€åˆ†éš”
- [x] 2.2.6 æ³•æ¢æœå°‹æŒ‰éˆ•æ”¹ç‚º inline æœå°‹æ¡†ï¼ˆä¸é–‹ dialogï¼‰ï¼Œæœå°‹çµæœç›´æ¥åœ¨ä¸‹æ–¹åˆ—è¡¨é¡¯ç¤º

#### 2.3 åˆ†æ Tabï¼ˆæ•´åˆåŸ AnalysisPanelï¼‰

- [x] 2.3.1 å»ºç«‹ `AnalysisSidebarContent` å…ƒä»¶
- [x] 2.3.2 ä½¿ç”¨ shadcn `Accordion` å…ƒä»¶ï¼ŒåŒ…å« 6 å€‹ itemï¼š
      | AccordionItem | æ¨™é¡Œ | Badge | å…§å®¹å…ƒä»¶ |
      |---------------|------|-------|---------|
      | disputes | çˆ­é»åˆ†æ | `{count}` | `<DisputesTab />` |
      | claims | ä¸»å¼µåœ–è­œ | `{count}` | `<ClaimsTab />` |
      | damages | é‡‘é¡è¨ˆç®— | `NT$ {total}` | `<DamagesTab />` |
      | timeline | æ™‚é–“è»¸ | `{count}` | `<TimelineTab />` |
      | evidence | ä¸»å¼µèˆ‡èˆ‰è­‰ | â€” | `<EvidenceTab />` |
      | parties | ç•¶äº‹äºº | â€” | `<PartiesTab />` |
- [x] 2.3.3 Accordion æ”¯æ´å¤šé …åŒæ™‚å±•é–‹ï¼ˆ`type="multiple"`ï¼‰
- [x] 2.3.4 å±•é–‹ç‹€æ…‹å­˜åœ¨ `useUIStore.analysisAccordion` ä¸­ï¼Œåˆ‡æ› tab å¾Œä¿ç•™
- [x] 2.3.5 èª¿æ•´å„ Tab å…ƒä»¶çš„ç©ºç‹€æ…‹æç¤ºæ–‡å­—ï¼ˆç§»é™¤ã€Œè«‹åœ¨èŠå¤©é¢æ¿è¼¸å…¥ã€â†’ã€Œé€é AI åŠ©ç†åˆ†æã€ï¼‰
- [x] 2.3.6 `ClaimsTab` åŸæœ¬ç”¨ `grid-cols-2` ä¸¦æ’ï¼Œåœ¨ sidebar çª„å¯¬ä¸‹æ”¹ç‚ºå‚ç›´å †ç–Šï¼ˆ`flex-col`ï¼‰
- [x] 2.3.7 `EvidenceTab` çš„è¡¨æ ¼åœ¨çª„å¯¬ä¸‹ç”¨å¡ç‰‡å¼å‘ˆç¾æ›¿ä»£æ°´å¹³è¡¨æ ¼
- [x] 2.3.8 `PartiesTab` åŸæœ¬ `flex gap-3` æ°´å¹³æ’åˆ—ï¼Œæ”¹ç‚ºå‚ç›´å †ç–Š
- [x] 2.3.9 å­—æ•¸çµ±è¨ˆç§»åˆ° StatusBar

### Phase 3ï¼šå¿«æ·éµ & ç´°ç¯€æ‰“ç£¨

- [ ] 3.1 å…¨åŸŸå¿«æ·éµï¼ˆæš«ç·©ï¼‰ï¼š
  - `Cmd+B` â€” åˆ‡æ›å³å´ sidebar å±•é–‹/æ”¶åˆ
  - `Cmd+J` â€” å±•é–‹å·¦å´ Chat + focus è¼¸å…¥æ¡†
  - `Cmd+1` â€” åˆ‡æ›åˆ°æ¡ˆä»¶è³‡æ–™ tab
  - `Cmd+2` â€” åˆ‡æ›åˆ°åˆ†æ tab
- [x] 3.2 Sidebar tab åˆ‡æ›æ™‚çš„éæ¸¡å‹•ç•«ï¼ˆfadeï¼Œä¸è¦ slideï¼Œé¿å…å¡é “ï¼‰
- [x] 3.3 ç¢ºä¿ `prefillInput` æµç¨‹æ­£å¸¸ï¼š
  - ç·¨è¼¯å™¨é¸å–æ–‡å­— â†’ SelectionToolbar æ“ä½œ â†’ è‡ªå‹•å±•é–‹å·¦å´ Chat â†’ å¡«å…¥ promptï¼ˆèˆ‡ç¾æœ‰è¡Œç‚ºä¸€è‡´ï¼‰
  - ä¿®å¾©ï¼š`useSelectionToolbar` ä¸­ `handleDiscussInChat` ç¾åœ¨æœƒè‡ªå‹•å±•é–‹å·¦å´ Chat
- [x] 3.4 ç¢ºä¿ `brief_update` SSE äº‹ä»¶ä»æ­£ç¢º dispatch åˆ° `useBriefStore` / `useAnalysisStore`
  - é©—è­‰ï¼š`sseHandlers.ts` ç›´æ¥æ“ä½œ Zustand storeï¼Œèˆ‡ UI ä½ˆå±€ç„¡é—œï¼Œç„¡éœ€ä¿®æ”¹
- [x] 3.5 åˆ†æ Accordion badge å³æ™‚æ›´æ–°ï¼ˆdisputes/damages è³‡æ–™è®ŠåŒ–æ™‚ badge æ•¸å­—è·Ÿè‘—è®Šï¼‰
  - é©—è­‰ï¼šZustand reactive selectors è‡ªå‹•æ›´æ–°ï¼Œç„¡éœ€é¡å¤–è™•ç†
- [x] 3.6 AI å®Œæˆé‡è¦æ“ä½œæ™‚é¡¯ç¤º Toast é€šçŸ¥ï¼ˆæ›¸ç‹€å®Œæˆã€åˆ†æå®Œæˆç­‰ï¼‰
  - å®‰è£ sonnerï¼ŒåŠ å…¥ `<Toaster />` åˆ° App æ ¹
  - æ›¸ç‹€å»ºç«‹ã€çˆ­é»åˆ†æã€é‡‘é¡è¨ˆç®—ã€æ™‚é–“è»¸ã€ä¸»å¼µåœ–è­œå®Œæˆæ™‚ toast.success
  - SSE error æ™‚ toast.error
- [x] 3.7 ç§»é™¤ä¸å†ä½¿ç”¨çš„å…ƒä»¶å’Œç¨‹å¼ç¢¼ï¼š
  - åˆªé™¤èˆŠ `AnalysisPanel.tsx`ï¼ˆPhase 1 å·²åˆªï¼‰
  - åˆªé™¤èˆŠ `LawSearchDialog.tsx`ï¼ˆå·²æ•´åˆè‡³ LawRefsSection inline æœå°‹ï¼‰
  - æ¸…ç† `useUIStore` ä¸­å·²ç§»é™¤çš„ `bottomPanel*` ç‹€æ…‹ï¼ˆPhase 1 å·²æ¸…ï¼‰

### Phase 4ï¼šéŸ¿æ‡‰å¼ & Edge Cases

- [ ] 4.1 çª„è¢å¹•ï¼ˆ< 1280pxï¼‰ï¼šå³å´ sidebar é è¨­æ”¶åˆï¼Œåªé¡¯ç¤º icon barï¼›å·¦å´ Chat é è¨­æ”¶åˆ
- [ ] 4.2 å¯¬è¢å¹•ï¼ˆâ‰¥ 1920pxï¼‰ï¼šå³å´ sidebar é è¨­å¯¬åº¦åŠ å¤§åˆ° 480px
- [ ] 4.3 ç¢ºèª sidebar resize handle èˆ‡ editor panel resize handle ä¸è¡çª
- [ ] 4.4 ç¢ºèªæª”æ¡ˆä¸Šå‚³ï¼ˆdrag-dropï¼‰åœ¨æ–°ä½ˆå±€ä¸­æ­£å¸¸é‹ä½œ
- [ ] 4.5 ç¢ºèª OutlinePanel / VersionPanel æµ®å‹• overlay åœ¨æ–°ä½ˆå±€ä¸­ä½ç½®æ­£ç¢º

---

### å—å½±éŸ¿çš„æª”æ¡ˆæ¸…å–®

| æ“ä½œ         | æª”æ¡ˆ                                                                                   |
| ------------ | -------------------------------------------------------------------------------------- |
| **å¤§å¹…ä¿®æ”¹** | `src/client/pages/CaseWorkspace.tsx`                                                   |
| **å¤§å¹…ä¿®æ”¹** | `src/client/stores/useUIStore.ts`                                                      |
| **é‡å¯«**     | `src/client/components/layout/RightSidebar.tsx`                                        |
| **æ–°å¢**     | `src/client/components/layout/sidebar/CaseMaterialsContent.tsx`                        |
| **æ–°å¢**     | `src/client/components/layout/sidebar/AnalysisSidebarContent.tsx`                      |
| **å°å¹…èª¿æ•´** | `src/client/components/layout/sidebar/BriefsSection.tsx` â€” ç§»é™¤ border-b               |
| **å°å¹…èª¿æ•´** | `src/client/components/layout/sidebar/FilesSection.tsx` â€” ç§»é™¤ border-b                |
| **å°å¹…èª¿æ•´** | `src/client/components/layout/sidebar/LawRefsSection.tsx` â€” ç§»é™¤ border-bï¼Œinline æœå°‹ |
| **å°å¹…èª¿æ•´** | `src/client/components/analysis/ClaimsTab.tsx` â€” éŸ¿æ‡‰å¼å‚ç›´å †ç–Š                        |
| **å°å¹…èª¿æ•´** | `src/client/components/analysis/EvidenceTab.tsx` â€” å¡ç‰‡å¼å‘ˆç¾                          |
| **å°å¹…èª¿æ•´** | `src/client/components/analysis/PartiesTab.tsx` â€” å‚ç›´å †ç–Š                             |
| **å°å¹…èª¿æ•´** | `src/client/components/analysis/DisputesTab.tsx` â€” ç©ºç‹€æ…‹æ–‡å­—æ›´æ–°                      |
| **åˆªé™¤**     | `src/client/components/analysis/AnalysisPanel.tsx`ï¼ˆæ•´åˆåˆ° AnalysisSidebarContentï¼‰    |
| **ä¸å‹•**     | `src/client/components/layout/ChatPanel.tsx`ï¼ˆä¿ç•™å·¦å´ï¼Œä¸å‹•ï¼‰                         |
| **ä¸å‹•**     | `src/client/components/layout/SidebarStrip.tsx`ï¼ˆå·¦å´æ”¶åˆæ¢ä¿ç•™ï¼‰                      |
| **ä¸å‹•**     | æ‰€æœ‰ Zustand storesï¼ˆé™¤ useUIStoreï¼‰ã€editor å…ƒä»¶ã€å¾Œç«¯                                |
